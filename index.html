<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>アイヌ民族星文化ビューア ～カムイの星図～</title>

    <!-- レスポンシブ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- d3-celestial の CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.35/celestial.css"
    />
    <!-- 自前の CSS -->
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="site-header-include"></div>

    <main class="layout">
      <section class="controls">
        <div id="loading-indicator" class="loading" aria-live="polite"></div>

        <div class="field">
          <select id="city-select">
            <option value="">……</option>
          </select>
        </div>

        <div id="region-info">星文化地域：未選択</div>

        <div
          id="area-map-preview"
          class="area-map-preview"
          aria-label="エリアマップ"
        >
          <img id="area-map-single" class="area-map-image" alt="エリアマップ" />
          <div id="area-map-stack" class="area-map-stack" aria-hidden="true">
            <img
              src="img/area1.png"
              class="area-stack-layer"
              alt="エリアマップ"
            />
            <img
              src="img/area2.png"
              class="area-stack-layer"
              alt="エリアマップ"
            />
            <img
              src="img/area3.png"
              class="area-stack-layer"
              alt="エリアマップ"
            />
            <img
              src="img/area4.png"
              class="area-stack-layer"
              alt="エリアマップ"
            />
            <img
              src="img/area5.png"
              class="area-stack-layer"
              alt="エリアマップ"
            />
            <img
              src="img/area0.png"
              class="area-stack-layer area-stack-top"
              alt="エリアマップ"
            />
          </div>
        </div>
        <br />

        <!-- 投影法選択プルダウン -->
        <div class="field">
          <label for="projection-select">星図投影法：</label>
          <select id="projection-select">
            <option value="aitoff">アイトフ投影（標準）</option>
            <option value="mollweide">モルワイデ投影</option>
            <option value="hammer">ハンマー投影</option>
            <option value="orthographic">正射投影</option>
            <option value="stereographic">ステレオグラフ投影</option>
            <!--<option value="gnomonic">グノモニック投影</option>-->
            <!--<option value="sinusoidal">サインスイダル投影</option>-->
            <!--<option value="albers">アルバース投影</option>-->
            <!--<option value="azimuthal equal area">方位等積投影</option>-->
            <!--<option value="azimuthal equidistant">方位等距離投影</option>-->
            <option value="mercator">メルカトル投影</option>
            <option value="equirectangular">正距円筒図法</option>
          </select>
        </div>

        <div class="field">
          <!-- 88星座表示ON/OFFチェックボックス -->
          <label for="toggle-constellations"
            ><input
              type="checkbox"
              id="toggle-constellations"
              checked
            />88星座表示</label
          >
        </div>

        <hr />

        <h2>アイヌ民族星文化一覧</h2>
        <ul id="ainu-list" class="ainu-list">
          <li>……</li>
        </ul>
      </section>

      <section class="map-area">
        <!-- d3-celestial がここにキャンバスを作る -->
        <div id="celestial-map"></div>

        <!-- d3-celestial キャンバス下 note -->
        <p class="note">
          ※ 星図上では紫/緑色でアイヌ民族の星文化を描画しています。
        </p>
        <!-- d3-celestial キャンバス下 attention -->
        <p class="attention">
          当サイトに掲載されている星図・星座線・星文化情報・地図情報など、すべてのコンテンツのダウンロードおよび無断複製（スクリーンショット等を含む）は固く禁止いたします。
          <br />ご利用を希望される場合は、必ず管理者：<a
            href="https://x.com/trapezium_orion"
            target="_blank"
            rel="noopener"
            >@trapezium_orion (X/Twitter)</a
          >までお問い合わせください。 <br />&copy; 2025–2026 Ainu Star Culture
          プロジェクト
        </p>
      </section>
    </main>

    <!-- d3-celestial 関連ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.35/lib/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.35/lib/d3.geo.projection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.35/celestial.min.js"></script>

    <!-- 自前の JS -->
    <!-- キャッシュ更新用にバージョンを付与 -->
    <script src="js/dataLoader.js?v=2"></script>
    <script src="js/main.js?v=2"></script>
    <script src="js/includes.js?v=2"></script>
    <script>
      // --- コンテンツ保護（軽い抑止） ---
      // ※静的配信では「完全な抜き取り防止」は不可能です。
      //   ここでは UI 操作（右クリック/ドラッグ/選択/一部ショートカット）を抑止し、注意喚起します。

      // これらの領域上では保護を適用する（画像 + 星図）
      const PROTECT_SELECTORS = [
        "#area-map-preview img", // エリア画像
        "#celestial-map", // 星図コンテナ（配下の canvas/svg を含む）
      ];

      const isInProtectedArea = (target) => {
        if (!target || !target.closest) return false;
        return PROTECT_SELECTORS.some((sel) => !!target.closest(sel));
      };

      // alert() はUXが悪いので廃止し、簡易トーストで通知（連打防止あり）
      const toast = (() => {
        let el;
        let lastAt = 0;
        let timer;
        const ensure = () => {
          if (el) return el;
          el = document.createElement("div");
          el.id = "protect-toast";
          el.setAttribute("role", "status");
          el.setAttribute("aria-live", "polite");
          // インラインで最小限（CSSファイル改変不要）
          Object.assign(el.style, {
            position: "fixed",
            left: "50%",
            bottom: "16px",
            transform: "translateX(-50%)",
            maxWidth: "min(92vw, 720px)",
            background: "rgba(0,0,0,0.78)",
            color: "#fff",
            padding: "10px 12px",
            borderRadius: "10px",
            fontSize: "14px",
            lineHeight: "1.4",
            zIndex: "99999",
            boxShadow: "0 8px 22px rgba(0,0,0,0.35)",
            opacity: "0",
            pointerEvents: "none",
            transition: "opacity 120ms ease",
          });
          document.body.appendChild(el);
          return el;
        };

        return (message) => {
          const now = Date.now();
          // 連打防止（キー押しっぱなし/連続イベント対策）
          if (now - lastAt < 1200) return;
          lastAt = now;

          const node = ensure();
          node.textContent = message;
          node.style.opacity = "1";
          clearTimeout(timer);
          timer = setTimeout(() => {
            node.style.opacity = "0";
          }, 1600);
        };
      })();

      const preventWithNotice = (e, message) => {
        e.preventDefault();
        // 一部イベントでは stopPropagation も併用（右クリックメニュー等）
        if (typeof e.stopPropagation === "function") e.stopPropagation();
        if (message) toast(message);
      };

      // 右クリック（コンテキストメニュー）を抑止（画像 + 星図）
      document.addEventListener(
        "contextmenu",
        function (e) {
          if (!isInProtectedArea(e.target)) return;
          preventWithNotice(
            e,
            "当サイト掲載コンテンツの複製・保存（スクリーンショット等を含む）は禁止されています。",
          );
        },
        true,
      );

      // ドラッグ開始を抑止（画像 + 星図）
      document.addEventListener(
        "dragstart",
        function (e) {
          if (!isInProtectedArea(e.target)) return;
          preventWithNotice(e);
        },
        true,
      );

      // 選択開始を抑止（画像 + 星図）
      // ※テキスト選択まで潰すと不便なので、保護領域に限定
      document.addEventListener(
        "selectstart",
        function (e) {
          if (!isInProtectedArea(e.target)) return;
          preventWithNotice(e);
        },
        true,
      );

      // 主要ショートカット抑止（完全ではない）
      document.addEventListener(
        "keydown",
        function (e) {
          // 入力欄を巻き込まない（UX/アクセシビリティ配慮）
          const tag =
            e.target && e.target.tagName ? e.target.tagName.toUpperCase() : "";
          if (
            tag === "INPUT" ||
            tag === "TEXTAREA" ||
            (e.target && e.target.isContentEditable)
          )
            return;

          const key = (e.key || "").toLowerCase();
          const isCtrlOrMeta = e.ctrlKey || e.metaKey; // Windows/Linux: Ctrl, macOS: Cmd
          const isOnProtected =
            isInProtectedArea(e.target) ||
            isInProtectedArea(document.activeElement);

          // 保護領域にフォーカス/操作があるときだけ強めに抑止
          if (!isOnProtected) {
            // ただし DevTools 系はページ全体で軽く抑止（抜け道は多数）
            // F12 / Ctrl+Shift+I/C/J / Cmd+Opt+I 相当
          }

          const isDevtools =
            e.key === "F12" ||
            (isCtrlOrMeta &&
              e.shiftKey &&
              (key === "i" || key === "j" || key === "c"));

          const isViewSource = isCtrlOrMeta && key === "u";
          const isSave = isCtrlOrMeta && key === "s";
          const isCopy = isCtrlOrMeta && key === "c";
          const isPrint = isCtrlOrMeta && key === "p";

          // PrintScreen（OS機能のため抑止できないケースが多い）
          if (e.key === "PrintScreen") {
            preventWithNotice(e, "画面コピーは禁止されています。");
            return;
          }

          // Devtools/ソース表示はページ全体で抑止（効果は限定的）
          if (isDevtools || isViewSource) {
            preventWithNotice(e, "この操作は禁止されています。");
            return;
          }

          // コピー/保存/印刷は「保護領域に関連する操作のときだけ」抑止
          if (isOnProtected && (isCopy || isSave || isPrint)) {
            preventWithNotice(e, "この操作は禁止されています。");
          }
        },
        true,
      );
    </script>
  </body>
</html>
